<!--more-->

# 一，嵌入式系统简介

## 1. 嵌入式系统与 PC 机的区别

## 2. 嵌入式系统的开发流程

# 二，ARM 体系结构

## 1. ARM9 体系结构的特点

### RISC

- 指令系统中仅选取使用**频率最高**的一些简单指令
- **指令长度固定**，指令格式种类少，寻址方式种类少；固定+规整
- 只有**取数/存数**两条指令访问存储器，其余指令的操作都在寄存器内完成
- 采用**流水线**技术及超标量和超流水线技术，使得大部分指令在一个时钟周期内完成
- 控制器采用**组合逻辑**控制
- CPU 中设计**多个通用寄存器**
- 采用**优化编译**程序

### THUMB 指令集

是 32 位 ARM 指令集的子集，按 16 位指令重新编码

- 代码尺寸小，提高代码密度
- 简化设计

### 流水线

ARM9 流水线增加到 5 级，增加了**存储器访问段**和**回写段**，使 ARM9 处理能力平均可达到 1.1 Dhrystone，指令吞吐量增加了约 13%

优点：随着流水线深度（级数）的增加，每一段的工作量被削减了，这使得处理器可以工作在更高的频率，同时改进了性能

缺点：增加了系统的延时，即内核在执行一条指令前，需要更多的周期来填充流水线；某些段之间会产生数据相关

### 哈佛结构

- 冯诺伊曼结构数据和指令共用一个 Cache；**哈佛体系**结构有独立的指令和数据 Cache
- **Cache** 改善了系统的整体性能，但也使程序的执行时间变得不可预测，对实时系统而言，代码执行的确定性——装载和存储指令或数据的时间必须是可预测的
- ARM 采用**紧耦合内存 TCM** 实现可预测，TCM 紧靠内核，保证取指或数据操作的时钟周期数。**TCM 位于存储器的地址映射中**，可作为快速存储器访问
- 结合 Cache 和 TCM，ARM 即能改善性能，又能够获得可预测的实时响应

## 2. ARM9 两种操作状态

ARM9TDMI 有两种操作状态

- ARM-32bit，按**字**排列的 ARM 指令集
- Thumb-16bit，按**半字**排列的 Thumb 指令集

<!-- TODO 为什么切换两种状态 -->

切换：

- 操作状态可以通过 `BX` 指令（带状态切换的分支指令）在 ARM 状态和 Thumb 状态之间切换
- 一旦进入异常模式，（IRQ，FIQ，RESET，UNDEF，ABORT，SWI），也进入 ARM 状态

`BX` 指令的作用：

- 跳转
- 用 R0 的最后一位改变程序状态寄存器 CPSR 中的 T 控制位

## 3. 7 个基本工作模式

### 工作模式

ARM 有 7 个基本工作模式:

1. User:用户模式（非特权模式），大部分任务执行在这种模式
   - 正常程序执行的模式
2. FIQ:当一个高优先级(fast)**中断**产生时将会进入这种模式
   - 高速数据传输和通道处理
3. IRQ:当一个低优先级(normal)**中断**产生时将会进入这种模式
   - 通常的中断处理
4. Supervisor（管理、SVC）:当**复位**或**软中断指令 SWI** 执行时进入
   - 供操作系统使用的一种保护模式
5. Abort: 当**存取数据**或**预取指令异常**时将会进入这种模式
   - 虚拟存储及存储保护
6. Undef: 当执行未定义指令时会进入这种模式
   - 软件仿真硬件协处理器
7. System: 使用和 User 模式相同寄存器集的特权模式
   - 特权级的操作系统任务

- 除用户模式外，其它 6 种称为非用户模式或特权模式，用户模式下有些被保护的资源(如 CPSR)访问受限
- 中间的 5 种统称异常模式，用于处理中断（FIQ、IRQ、软中断）或异常，以及访问被保护的资源
- 上电复位，或执行 SWI 指令进入 SVC 模式
- 响应外部中断进入 FIQ 或 IRQ 模式
- 存取数据或预取指令异常时将会进入 Abort 模式
- 当执行未定义指令时会进入 Undef 模式
- 除 User 外，其它模式下通过修改 CPSR 可改变模式

### 寄存器

寄存器，共有 37 个：

![picture 1](../../images/2022-14-00-25-50.png)

- 在 Thumb 方式下可直接访问 R0-R7，PC，SP，CPSR，SPSR
- 在 Thumb 方式下可受限制地访问其它寄存器，只做暂存器用
- 在 ARM 方式下 R15 的位[1:0]为 0，使用[31:2]作为 PC
- 在 Thumb 方式下 R15 的位[0]为 0，使用[31:1]作为 PC

CPSR 的访问权

- 处理器模式主要决定了哪些寄存器是活动的及对 CPSR 的访问权
- 除 USER 模式之外，其余都是特权模式，特权模式允许对 CPSR 的完全读/写访问
- USER 模式中允许对 CPSR 的控制域进行读访问，但允许对标志位的读写访问
- 系统模式是一种特殊的用户模式，允许对 CPSR 的完全读写访问

## 4. 异常响应流程

异常类型

- FIQ
- IRQ(Interrupt ReQuest)
- 未定义指令(UDEF)
  - 当 ARM 接受到一条不能处理的指令,ARM 把这条指令提供给任何一个协处理器执行
  - 如果协处理器可以执行这条指令但此时协处理器忙,ARM 将等待直到协处理器准备好或中断发生
  - 如果没有协处理器处理这条指令,那么 ARM 将处理未定义的指令陷井
- 指令预取中止(PABT)
- 数据中止(DABT)
- 复位
- 软件中断 Software interrupt
  - 通过执行指令 SWI 产生
  - 用于从用户模式切换到特权模式
  - 通常要求特殊的管理功能，如操作系统支持

异常优先级

1. Reset (highest priority)
2. Data abort(DABT)
3. FIQ
4. IRQ
5. Prefetch abort(PABT)
6. 未定义指令(UDEF)
7. Software interrupt (最低优先级)

- 当异常产生时, ARM core（软件用红字）:
  - 拷贝 CPSR 到该异常模式的 SPSR\_\<mode\>
  - 设置适当的 CPSR 位：
    - 改变处理器状态进入 ARM 态
    - 改变处理器模式进入相应的异常模式
    - 设置中断禁止位禁止相应中断 (如需要)
  - 保存返回地址(PC4)到 LR\_\<mode\>
  - 设置 PC 为相应的异常向量
- 返回时, 异常处理需要:
  - 从 SPSR\_\<mode\>恢复 CPSR
  - 从 LR\_\<mode\>恢复 PC
  - Note: 这些操作只能在 ARM 态执行.

:star: ARM7/9 保存 PC-4 为断点的原因是五级流水线

进入异常的操作

```assemble
   SPSR_<Exception_Mode>=CPSR  ; 拷贝 CPSR 到 SPSR_<mode>
   CPSR[4:0]=Exception Mode Number
   CPSR[5]=0                   ; 若原来是Thumb态，则进入 ARM 态，以
                               ; 便统一以ARM 态计算返回地址
   R14_<Exception_Mode>=Return Link ; 保存返回地址到 LR_<mode>
   IF<Exception_Mode>==Reset or FIQ then
      CPSR[6]=1                ; 当响应FIQ异常时，禁止新的FIQ/IRQ异常
      CPSR[7]=1;
   PC=Exception Vector Address ; 设置 PC 为相应的异常向量
```

## 5. 各种异常的返回方法

- X86 有专门的返回指令：RET、RETI
- 作为 RISC 机，ARM 没有，需要编程：根据保存的 LR\_\<mode\>,恢复 PC 值

# 三，ARM 指令系统

3.1、ARM 指令语法，即下面的 3.2、3.3  
3.2、第 2 操作数的语法
(1)立即数型——#immed_8r： 要求
(2)寄存器移位型——{Rm{, <shift>}}
3.3、如果立即数型无法满足要求，两种解决办法，第二种办法的实现原理
3.4、寻址方式
基址变址寻址的 4 种形式
多寄存器寻址的 4 种形式
堆栈寻址的 4 种形式
相对寻址：B、LDR
3.5、常用指令（除红字外不直接考，而是为了 3.7）
转移指令：B、 BL、BX、BLX
Load/Store 指令：LDR/STR、 LDM/ STM、SWP
杂项指令：MOV、CMP、TEST、BIC、MRS/MSR（工作模式切换、FIQ/IRQ 中断允许/禁止）
3.6、常用伪指令（除红字外不直接考，而是为了 3.7）
EQU
GBLS、SETS (字符串)
DCB、DCW、DCD、 SPACE、 LTORG
AREA
LDR、ADR
3.7、LDR 伪指令与汇编指令的区别
3.8、阅读汇编程序段：如第 3 章最后的 ARM 汇编程序实例、3.4 节的 SWI 中断例程、6.3 节的 S3C2440X 复位程序、外部中断服务程序框架，特别是利用散转表实现多路分支等。

```assembly
   AREA Block, CODE, READONLY;定义代码段Block
NUM  EQU 20	;设置将要复制的字数
   ENTRY		;标识程序入口点
   LDR R0, =src 	;R0寄存器指向源数据区src
   LDR R1, =dst 	;R1寄存器指向目标数据区dst
   MOV R2, #NUM	;R2指定将要复制的字数
   MOV SP, #0X400 ;设置数据栈指针，用于保存工作寄存器

Bcopy MOVS  R3, R2, LSR #3
                  ;需要进行的以8个字为单位的复制次数
   BEQ  Cword     ;若不足8个字，则右移后R2=0，Z=1
                  ;则跳转到Cword以字为单位复制
   BLNE Ocopy     ;调用子程序

Cword ANDS  R2,R2, #7 ;剩下不足8个字的数据的字数
   BEQ   stop         ;数据复制完成
Wcopy
   LDR   R3,[R0],#4   ;从源数据区读取1个字到R3寄存器
                      ; 并更新目标数据区指针R0
   STR   R3,[R1],#4   ;将R3中数据写入目标数据区，并更新R1
   SUBS  R2,R2,#1     ;将字数减1
   BNE   Wcopy        ;循环,直到完成以字为单位的数据复制

Stop              ;程序结束处理
   MOV R0,#0x18	; 向SWI中断程序参数传递
   SWI 0x123456   ;执行中断，对数据处理

   AREA Bdata,DATA,READWRITE ;定义数据区Bdata
src DCD 1,2,3,4,5,6,7,8,1,2,3,4,5,6,7,8,1,2,3,4 ;源数据区src
dst DCD 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ;目标数据区dst
   END      ;结束本文件汇编

   AREA OCOPY, CODE, READONLY;定义代码段OCOPY
Ocopy
   STMFD SP!,{R4-R11} ;保存工作寄存器，满减：最后sp指向R4
REP
   LDMIA R0!,{R4-R11} ;读源数据区8个字，更新目标数据区指针R0
   STMIA R1!,{R4-R11} ;写到目标数据区，更新目标数据区指针R1
   SUBS  R3, R3, #1   ;将块复制次数减1
   BNE   REP          ;循环,直到完成以8个字为单位的块复制
   LDMFD SP!,{R4-R11} ;恢复工作寄存器值
   MOV PC, LR	       ;恢复断点，返回
   END                ;结束汇编
```

# 四，ARM 编程

4.1、映像文件的组织，考虑对齐问题时 RO、RW、ZI 的起止地址
以 4.2 节程序框架为例
以 6.3 节中断程序框架为例：RW Base 设置为 0x33FFE700

4.2、常用指令、伪指令（特别是 LDR）汇编后的机器指令情况（包括偏移地址解释等）

1、8 条指令，其中 6 条伪指令，但汇编后仍 8 条，占 32 字节（20），因此地址为 0-1F。代码段结束后有文字池，文字池以 32 字节为单位。
2、RO 还有一个数据段， ALIGN=6，只能从地址后 6 位为 0 处开始，即 40H 开始，22 个字符，到 55H。又由于 ALIGN=6，该段长度为 64 整数倍，即 64 字节。
3、RW 的 ALIGN=5，后面至少 5 个 0，所以从 80H 开始

4.3、ATPCS
（1）c 调用汇编：见例 2  
 c 使用 extern 关键词声明要调用的汇编程序，并且把该汇编程序声明为 c 的函数原型
c 调用时，实参传给 R0 ～ R3
被调汇编程序使用 EXPORT 声明
被调汇编执行时从 R0 ～ R3 取参数，执行结束时将结果放在 R0 ～ R1，由 c 程序取走。该程序最后要有返回语句

（2）汇编调用 c 函数：见例 3
定义 c 函数
汇编程序使用 IMPORT+函数名进行声明
汇编程序将实参放到 R0 ～ R3 中
汇编程序用调用：BL 函数名 {参数表}
被调 c 执行前，先从 R0 ～ R3 取实参，付给形参，然后执行，将结果放在 R0 ～ R1。
返回汇编程序后，从 R0 ～ R1 取结果

4.3、ATPCS
（3）掌握结构体参数的定义、传递方法

# 五，ARM 最小系统设计

5.1、S3C2440 是什么芯片？
5.2、S3C2440 的最小系统什么含义？通常包括哪些部分的设计？各部分作用是什么？
5.3、S3C2440 的存储空间为什么按 Bank 组织？nGCS[0:7]、 nWBE[3:0]信号的作用、如何产生的？为什么连接存储器时只有 27 根地址 ADDR[0:26]？
5.4、不同类型、字长存储芯片的连接、IO 接口芯片的连接
5.5、S3C2440 的两种启动方式。如果采用 NOR Flash 启动， NOR Flash 的应该位于哪个 Bank？
5.6、NAND Flash 的特点是什么？
S3C2440 是如何支持 NAND Flash？（1）连接；（2）自引导+Steppingstone
NAND Flash 自引导的原理
5.7、BOOTLOADER 是什么？什么情况用？

# 六，ARM 系统设计

6.1、S3C2440 的 GPIO 是什么？如何使用？
6.2、 S3C2440 的 UART 是什么？如何使用？
6.3、 S3C2440 的 Watchdog 是什么？如何使用？
6.4、SWI 中断程序的处理流程及代码\*
6.5、包括外部中断服务程序的程序框架
中断向量表：…
复位异常处理程序：…，关于外部中断的部分
外部中断服务程序：
查询 32 路中断，设置 32 路中断散转表
每个散转程序进一步查询，并处理
